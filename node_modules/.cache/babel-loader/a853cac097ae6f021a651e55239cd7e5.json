{"ast":null,"code":"import _slicedToArray from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectSpread from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/mandeep/Downloads/Song-sorch work/site/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React,{useEffect,useState}from\"react\";import{cachedFetch}from\"./Cache\";import{CustomTimeAgo,isServer}from\"./Common\";import\"./Comments.css\";import{Helmet}from\"react-helmet\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var SUBMITTED_COMMENTS_STORAGE_KEY=\"submittedComments\";export var SongComments=/*#__PURE__*/function(_React$PureComponent){_inherits(SongComments,_React$PureComponent);var _super=_createSuper(SongComments);function SongComments(){var _this;_classCallCheck(this,SongComments);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={loadingComments:false,savingComment:false,serverError:null,submissionError:null,comments:_this.props.comments||null,commentsCount:_this.props.commentsCount||null,submittedComments:[],commentSubmitted:null,commentEdited:null,commentDeleted:null,searchedId:_this.props.searchedId,replyComment:null,editComment:null,csrfToken:null,highlightComment:null,highlitComment:null,hasCommented:false};_this.loadCSRFToken=function(){var url=\"/api/comments?csrftoken=1\";fetch(url).then(function(r){if(_this.dismounted)return;if(r.ok){return r.json().then(function(result){_this.setState({csrfToken:result.csrf_token});});}else{_this.setState({serverError:r});}}).catch(function(error){if(_this.dismounted)return;_this.setState({serverError:error});});};_this.loadComments=function(){var _this$props=_this.props,song=_this$props.song,search=_this$props.search;var _this$state=_this.state,submittedComments=_this$state.submittedComments,commentEdited=_this$state.commentEdited;var submittedCommentIds=[];var url=\"/api/comments\";if(song){url+=\"?song=\".concat(song.id);}else if(search){url+=\"?search=\".concat(search.id);}else{// throw new Error(\"Don't know how to do this outside of song\");\n}if(submittedComments.length){submittedCommentIds=submittedComments.filter(function(submission){if(song){return submission.song===song.id;}else if(search){return submission.search===search.id;}else{return!submission.song&&!submission.search;}}).map(function(submission){return submission.id;});}submittedCommentIds.forEach(function(id){url+=url.includes(\"?\")?\"&\":\"?\";url+=\"submitted=\".concat(id);});if(commentEdited){// Just to extra-bust the cache\nurl+=url.includes(\"?\")?\"&\":\"?\";url+=\"edited=\".concat(commentEdited.id);}var fetchFunc;if(commentEdited&&submittedCommentIds.length){// Don't use the caching one\nfetchFunc=fetch;}else{fetchFunc=cachedFetch;}fetchFunc(url).then(function(r){if(_this.dismounted)return;_this.setState({loadingComments:false});if(r.ok){return r.json().then(function(result){_this.setState({csrfToken:result.csrf_token,comments:result.comments,commentsCount:result.comments_count,loadingComments:false},_this.consolidateSubmittedComments);});}else{_this.setState({serverError:r,loadingComments:false});}}).catch(function(error){if(_this.dismounted)return;_this.setState({serverError:error,loadingComments:false});});};_this.consolidateSubmittedComments=function(){var comments=_this.state.comments;var submittedComments=_this.state.submittedComments;if(submittedComments.length&&comments[\"\"]&&comments[\"\"].length){var recurse=function recurse(comments){comments.forEach(function(comment){if(!comment.not_approved){// Add to removeSubmittedComments only if this is one of the ones\n// you submitted.\nsubmittedComments.forEach(function(submittedComment){if(submittedComment.id===comment.id){removeSubmittedComments.push(submittedComment.id);}});}if(comments[comment.id]){recurse(comments[comment.id]);}});};// If any of your submitted comments is now approved, we need to remove\n// it from sessionStorage.\nvar removeSubmittedComments=[];recurse(comments[\"\"]);if(removeSubmittedComments.length){var newSubmittedComments=submittedComments.filter(function(submittedComment){return!removeSubmittedComments.includes(submittedComment.id);});_this.setState({submittedComments:newSubmittedComments},function(){if(_this.state.submittedComments.length){// Update\ntry{sessionStorage.setItem(SUBMITTED_COMMENTS_STORAGE_KEY,JSON.stringify(_this.state.submittedComments));}catch(ex){console.warn(\"'sessionStorage.setItem(SUBMITTED_COMMENTS_STORAGE_KEY)' did't work\");}}else{// Reset\ntry{sessionStorage.removeItem(SUBMITTED_COMMENTS_STORAGE_KEY);}catch(ex){}}});}}};_this.highlightComment=function(id){var highlitComment=_this.state.highlitComment;if(highlitComment&&highlitComment===id){highlitComment=null;}else{highlitComment=id;}_this.setState({highlitComment:highlitComment},function(){window.setTimeout(function(){if(!_this.dismounted&&_this.state.highlitComment===id){_this.setState({highlitComment:null});}},10*1000);});};_this.submitCommentHandler=function(data){_this.setState({savingComment:true},function(){_this._submitCommentHandler(data).then(function(){_this.setState({savingComment:false});});});};_this._submitCommentHandler=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){var response,_this$props2,song,search,_this$state2,submittedComments,csrfToken,formData,result;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this$props2=_this.props,song=_this$props2.song,search=_this$props2.search;_this$state2=_this.state,submittedComments=_this$state2.submittedComments,csrfToken=_this$state2.csrfToken;if(csrfToken){_context.next=4;break;}throw new Error(\"No csrfToken prepared\");case 4:formData=new FormData();formData.append(\"csrfmiddlewaretoken\",csrfToken);formData.append(\"text\",data.comment);formData.append(\"name\",data.name);formData.append(\"email\",data.email);if(submittedComments.length){submittedComments.filter(function(submission){if(song){return submission.song===song.id;}else if(search){return submission.search===search.id;}else{return!submission.song&&!submission.search;}}).forEach(function(submission){formData.append(\"submitted\",submission.id);});}if(!data.editComment){_context.next=15;break;}formData.append(\"id\",data.editComment.id);if(data.editComment.oid){_context.next=14;break;}throw new Error(\"Can't edit if you don't have the oid\");case 14:formData.append(\"oid\",data.editComment.oid);case 15:if(data.replyComment){formData.append(\"parent\",data.replyComment.id);}if(data.askedWasSearchedFor){formData.append(\"was_searched_for\",data.wasSearchedFor||false);}if(_this.state.searchedId){formData.append(\"search\",_this.state.searchedId||null);}if(data.parent){formData.append(\"parent\",data.parent||null);}formData.append(\"experiment\",data.experiment||{});if(song){formData.append(\"song\",song.id);}else if(search){formData.append(\"search\",search.id);}else{// throw new Error(\"Don't know how to do this outside of song\");\n}_context.prev=21;_context.next=24;return fetch(\"/api/comments\",{method:\"POST\",body:formData});case 24:response=_context.sent;if(!response.ok){_context.next=37;break;}// If posted a comment because this *was* the song you\n// searched for, let's kill that not to stop asking that question.\nif(_this.state.searchedId){try{localStorage.removeItem(\"searched\");}catch(ex){console.warn(\"'localStorage.removeItem(\\\"searched\\\")' didn't work\");}}_context.next=29;return response.json();case 29:result=_context.sent;if(!data.editComment){_context.next=34;break;}return _context.abrupt(\"return\",_this.setState({searchedId:null,commentEdited:result.submitted,submissionError:null,commentSubmitted:null,editComment:null,replyComment:null,comments:result.comments,commentsCount:result.comments_count}));case 34:return _context.abrupt(\"return\",_this.setState({searchedId:null,submissionError:null,commentEdited:null,commentSubmitted:result.submitted,commentDeleted:null,replyComment:null,comments:result.comments,commentsCount:result.comments_count},function(){// Only do this if there is only exactly 1 of these in the DOM.\n// The reason why is that when repeatedly injecting the <SongComments>\n// components in multiple places, you might have different ones\n// for different expanded songs.\nif(document.querySelectorAll(\".alert-comment\").length===1){document.querySelector(\".alert-comment.alert-success\").scrollIntoView({behavior:\"smooth\"});}var commentSubmitted=_this.state.commentSubmitted;var _this$props3=_this.props,song=_this$props3.song,search=_this$props3.search;_this.highlightComment(commentSubmitted.id);var submittedComments=_this.state.submittedComments.slice(0);// If you accidentally double-clicked to submit twice.\n// Or, just wrote the exact same comment twice, the server\n// won't create another record but it will respond as if it worked\n// so we need to check first that we don't already have\n// this 'commentSubmitted.id` already.\n// If you accidentally double-clicked to submit twice.\n// Or, just wrote the exact same comment twice, the server\n// won't create another record but it will respond as if it worked\n// so we need to check first that we don't already have\n// this 'commentSubmitted.id` already.\nif(!submittedComments.map(function(o){return o.id;}).filter(function(id){return id===commentSubmitted.id;}).length){var toPush={id:commentSubmitted.id,oid:commentSubmitted.oid};if(song){toPush.song=song.id;}else if(search){toPush.search=search.id;}submittedComments.push(toPush);}_this.setState({submittedComments:submittedComments,submissionError:null},function(){_this.loadComments();try{sessionStorage.setItem(SUBMITTED_COMMENTS_STORAGE_KEY,JSON.stringify(_this.state.submittedComments));}catch(ex){}});}));case 35:_context.next=38;break;case 37:return _context.abrupt(\"return\",_this.setState({submissionError:response}));case 38:_context.next=44;break;case 40:_context.prev=40;_context.t0=_context[\"catch\"](21);console.warn(\"Submission failed:\",_context.t0);return _context.abrupt(\"return\",_this.setState({submissionError:_context.t0}));case 44:case\"end\":return _context.stop();}}},_callee,null,[[21,40]]);}));return function(_x){return _ref.apply(this,arguments);};}();_this.deleteCommentHandler=function(comment){_this.setState({savingComment:true},function(){_this._deleteCommentHandler(comment).then(function(){_this.setState({savingComment:false});});});};_this._deleteCommentHandler=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(comment){var response,formData,url;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:formData=new FormData();if(comment.oid){_context2.next=3;break;}throw new Error(\"Can't edit if you don't have the oid\");case 3:formData.append(\"id\",comment.id);formData.append(\"oid\",comment.oid);url=\"/api/comments/delete\";_context2.prev=6;_context2.next=9;return fetch(url,{method:\"POST\",body:formData});case 9:response=_context2.sent;_context2.next=15;break;case 12:_context2.prev=12;_context2.t0=_context2[\"catch\"](6);return _context2.abrupt(\"return\",_this.setState({submissionError:_context2.t0}));case 15:if(response.ok){_context2.next=17;break;}return _context2.abrupt(\"return\",_this.setState({submissionError:response}));case 17:return _context2.abrupt(\"return\",_this.setState({commentDeleted:comment,commentEdited:null,editComment:null,submissionError:null},function(){// Before we load comments, remove this one from localStorage\nvar submittedComments=_this.state.submittedComments;var filteredSubmittedComments=submittedComments.filter(function(submission){return submission.id!==comment.id;});_this.setState({submittedComments:filteredSubmittedComments},function(){_this.loadComments();try{sessionStorage.setItem(SUBMITTED_COMMENTS_STORAGE_KEY,JSON.stringify(_this.state.submittedComments));}catch(ex){}});}));case 18:case\"end\":return _context2.stop();}}},_callee2,null,[[6,12]]);}));return function(_x2){return _ref2.apply(this,arguments);};}();_this.setEditComment=function(comment){_this.setState({editComment:comment});};_this.setReplyComment=function(comment){if(_this.state.replyComment&&_this.state.replyComment.id===comment.id){_this.setState({replyComment:null,highlitComment:null,commentEdited:null});}else{_this.setState({replyComment:comment,highlitComment:comment.id,commentEdited:null});}};_this.clearCommentSubmitted=function(){_this.setState({commentSubmitted:null});};_this.clearCommentEdited=function(){_this.setState({commentEdited:null});};_this.clearCommentDeleted=function(){_this.setState({commentDeleted:null});};return _this;}_createClass(SongComments,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;// If you're here, you're a browser and no a server rendering.\nvar submittedCommentStorage=\"[]\";try{submittedCommentStorage=sessionStorage.getItem(SUBMITTED_COMMENTS_STORAGE_KEY)||\"[]\";}catch(ex){console.warn(\"'sessionStorage.getItem(SUBMITTED_COMMENTS_STORAGE_KEY)' didn't work\");}var submittedComments=JSON.parse(submittedCommentStorage);if(submittedComments.length){// Definitely load comments. Even if you arrived here with the comments\n// already server-side rendered.\n// Because, this call to loadingComments might be potentially different.\n// If you have commented on this song before, update that in state.\nvar hasCommented=false;var song=this.props.song;if(song){hasCommented=submittedComments.some(function(comment){return comment.song&&comment.song===song.id;});}this.setState({submittedComments:submittedComments,hasCommented:hasCommented,loadingComments:!this.state.comments},this.loadComments);}else{// If the comments were already loaded, we only need the csrfToken.\nif(!this.state.comments){this.setState({loadingComments:true},this.loadComments);}else{// We just need a new csrfToken\nthis.loadCSRFToken();}}if(window.location.hash){var re=/c(\\d+)$/;if(window.location.hash.match(re)){var id=parseInt(window.location.hash.match(re)[1],10);this.setState({highlitComment:id},function(){window.setTimeout(function(){if(!_this2.dismounted){var element=document.querySelector(\"#c\".concat(_this2.state.highlitComment));if(element&&element.scrollIntoView){element.scrollIntoView({behavior:\"smooth\"});}}},1000);window.setTimeout(function(){if(!_this2.dismounted&&_this2.state.highlitComment===id){_this2.setState({highlitComment:null});}},10*1000);});}}}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(prevProps.song!==this.props.song){this.setState({loadingComments:true,comments:null,commentsCount:null},this.loadComments);}}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.dismounted=true;}},{key:\"render\",value:function render(){var song=this.props.song;var _this$state3=this.state,comments=_this$state3.comments,commentsCount=_this$state3.commentsCount,submissionError=_this$state3.submissionError,commentSubmitted=_this$state3.commentSubmitted,commentEdited=_this$state3.commentEdited,commentDeleted=_this$state3.commentDeleted,submittedComments=_this$state3.submittedComments,searchedId=_this$state3.searchedId,editComment=_this$state3.editComment,replyComment=_this$state3.replyComment,savingComment=_this$state3.savingComment,highlitComment=_this$state3.highlitComment,hasCommented=_this$state3.hasCommented,csrfToken=_this$state3.csrfToken;return/*#__PURE__*/_jsxs(\"div\",{className:\"comments masters song-comments\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"application\",children:/*#__PURE__*/_jsxs(Helmet,{children:[/*#__PURE__*/_jsx(\"script\",{type:\"text/javascript\",language:\"javascript\",src:\"https://live.primis.tech/live/liveView.php?s=113482\"}),/*#__PURE__*/_jsxs(\"script\",{children:[\"try\",Typekit.load({async:true}),\" catch(e)\"]})]})}),/*#__PURE__*/_jsxs(\"h3\",{children:[\"Song Comments \",commentsCount?/*#__PURE__*/_jsxs(\"span\",{children:[\"(\",commentsCount,\")\"]}):null,/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsxs(\"small\",{children:[\"On \",/*#__PURE__*/_jsx(\"b\",{children:song.name}),\" \",/*#__PURE__*/_jsx(\"span\",{className:\"by\",children:\"by\"}),\" \",song.artist.name]})]}),/*#__PURE__*/_jsx(ShowCommentDeleted,{commentDeleted:commentDeleted,clearCommentDeleted:this.clearCommentDeleted}),/*#__PURE__*/_jsx(ShowComments,_objectSpread(_objectSpread({},this.props),{},{submissionError:submissionError,comments:comments,editComment:editComment,replyComment:replyComment,searchedId:searchedId,setEditComment:this.setEditComment,setReplyComment:this.setReplyComment,submitCommentHandler:this.submitCommentHandler,deleteCommentHandler:this.deleteCommentHandler,commentSubmitted:commentSubmitted,commentEdited:commentEdited,submittedComments:submittedComments,savingComment:savingComment,highlitComment:highlitComment,highlightComment:this.highlightComment,clearCommentSubmitted:this.clearCommentSubmitted,clearCommentEdited:this.clearCommentEdited,csrfToken:csrfToken,hasCommented:hasCommented}))]});}}]);return SongComments;}(React.PureComponent);function ShowCommentSubmitted(_ref3){var commentSubmitted=_ref3.commentSubmitted,clearCommentSubmitted=_ref3.clearCommentSubmitted;if(!commentSubmitted)return null;return/*#__PURE__*/_jsxs(\"div\",{className:\"alert-comment alert-comment alert alert-success alert-dismissible\",role:\"alert\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"close\",\"data-dismiss\":\"alert\",\"aria-label\":\"Close\",onClick:function onClick(event){clearCommentSubmitted();},children:/*#__PURE__*/_jsx(\"span\",{\"aria-hidden\":\"true\",children:\"\\xD7\"})}),/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"b\",{children:\"Comment submitted. Thank you!\"})}),/*#__PURE__*/_jsx(\"p\",{children:\"It needs to be moderated before publishing.\"})]});}function ShowCommentEdited(_ref4){var commentEdited=_ref4.commentEdited,clearCommentEdited=_ref4.clearCommentEdited;if(!commentEdited)return null;return/*#__PURE__*/_jsxs(\"div\",{className:\"alert-comment alert alert-success alert-dismissible\",role:\"alert\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"close\",\"data-dismiss\":\"alert\",\"aria-label\":\"Close\",onClick:function onClick(event){clearCommentEdited();},children:/*#__PURE__*/_jsx(\"span\",{\"aria-hidden\":\"true\",children:\"\\xD7\"})}),/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"b\",{children:\"Comment edited.\"})}),/*#__PURE__*/_jsx(\"p\",{children:\"You can keep editing it until it gets approved.\"})]});}function ShowCommentDeleted(_ref5){var commentDeleted=_ref5.commentDeleted,clearCommentDeleted=_ref5.clearCommentDeleted;if(!commentDeleted)return null;return/*#__PURE__*/_jsxs(\"div\",{className:\"alert-comment alert alert-success alert-dismissible\",role:\"alert\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"close\",\"data-dismiss\":\"alert\",\"aria-label\":\"Close\",onClick:function onClick(event){clearCommentDeleted();},children:/*#__PURE__*/_jsx(\"span\",{\"aria-hidden\":\"true\",children:\"\\xD7\"})}),/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"b\",{children:\"Comment removed.\"})}),/*#__PURE__*/_jsx(\"p\",{children:\"Feel free to write a new comment.\"})]});}function ShowSubmissionError(_ref6){var submissionError=_ref6.submissionError;var _useState=useState({}),_useState2=_slicedToArray(_useState,2),validationErrors=_useState2[0],setValidationErrors=_useState2[1];var isErrorResponse=false;if(!isServer){try{isErrorResponse=submissionError instanceof window.Response;}catch(err){// Old browsers. E.g. Firefox 38.\nconsole.log(\"instanceof window.Response did not work:\",err);}}useEffect(function(){if(!isServer&&isErrorResponse&&submissionError.status===400){submissionError.json().then(function(data){setValidationErrors(data.errors);});}},[submissionError,isErrorResponse]);if(!submissionError)return null;var errorMessage;if(!isServer&&isErrorResponse){if(submissionError.status===400){errorMessage=/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"b\",{children:\"Something's not right with the submission\"})}),Object.keys(validationErrors).map(function(key){return/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsxs(\"b\",{children:[key,\":\"]}),\" \",validationErrors[key].map(function(err){return/*#__PURE__*/_jsxs(\"span\",{children:[/*#__PURE__*/_jsx(\"i\",{children:err.message}),\" \",err.code?/*#__PURE__*/_jsxs(\"span\",{children:[\"(\",/*#__PURE__*/_jsx(\"code\",{children:err.code}),\")\"]}):null]},err.message+err.code);})]},key);})]});}else if(submissionError.status>=500){errorMessage=/*#__PURE__*/_jsx(\"p\",{children:\"Server error. Perhaps simply try again a little later.\"});}else{errorMessage=/*#__PURE__*/_jsx(\"p\",{children:\"The server basically failed to process the submission.\"});}}else{errorMessage=/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"code\",{children:submissionError.toString()})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"search-error\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Sorry, an error occured\"}),errorMessage]});}var ShowComments=/*#__PURE__*/function(_React$PureComponent2){_inherits(ShowComments,_React$PureComponent2);var _super2=_createSuper(ShowComments);function ShowComments(){_classCallCheck(this,ShowComments);return _super2.apply(this,arguments);}_createClass(ShowComments,[{key:\"render\",value:function render(){var _this$props4=this.props,comments=_this$props4.comments,replyComment=_this$props4.replyComment,editComment=_this$props4.editComment;return/*#__PURE__*/_jsxs(_Fragment,{children:[comments&&comments[\"\"]&&/*#__PURE__*/_jsx(ShowCommentsRecursive,_objectSpread(_objectSpread({},this.props),{},{allComments:comments,comments:comments[\"\"]})),!replyComment&&!editComment&&/*#__PURE__*/_jsx(CommentForm,_objectSpread({replyingComment:false},this.props))]});}}]);return ShowComments;}(React.PureComponent);var ShowCommentsRecursive=/*#__PURE__*/function(_React$PureComponent3){_inherits(ShowCommentsRecursive,_React$PureComponent3);var _super3=_createSuper(ShowCommentsRecursive);function ShowCommentsRecursive(){var _this3;_classCallCheck(this,ShowCommentsRecursive);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}_this3=_super3.call.apply(_super3,[this].concat(args));_this3.state={confirmDelete:false};return _this3;}_createClass(ShowCommentsRecursive,[{key:\"render\",value:function render(){var _this4=this;var confirmDelete=this.state.confirmDelete;var _this$props5=this.props,replyComment=_this$props5.replyComment,editComment=_this$props5.editComment,setEditComment=_this$props5.setEditComment,setReplyComment=_this$props5.setReplyComment,comments=_this$props5.comments,allComments=_this$props5.allComments,submittedComments=_this$props5.submittedComments,deleteCommentHandler=_this$props5.deleteCommentHandler,highlightComment=_this$props5.highlightComment,highlitComment=_this$props5.highlitComment,commentSubmitted=_this$props5.commentSubmitted,clearCommentSubmitted=_this$props5.clearCommentSubmitted,commentEdited=_this$props5.commentEdited,clearCommentEdited=_this$props5.clearCommentEdited,csrfToken=_this$props5.csrfToken;if(!comments.length)return null;return/*#__PURE__*/_jsx(\"div\",{className:\"comments\",children:comments.map(function(comment){// You're allowed to edit it if it was yours and it's not approved yet.\nvar canEdit=false;if(comment.not_approved){// Take 'editComment' into account\nif(submittedComments.filter(function(c){return c.id===comment.id;}).length){canEdit=true;}}var canReply=!canEdit&&csrfToken;var replies=allComments[comment.id];var editingComment=!!(canEdit&&editComment&&editComment.id===comment.id);var replyingComment=!!(canReply&&replyComment&&replyComment.id===comment.id);return/*#__PURE__*/_jsxs(\"div\",{className:\"comment\",id:\"c\".concat(comment.id),children:[commentSubmitted&&commentSubmitted.id===comment.id&&/*#__PURE__*/_jsx(ShowCommentSubmitted,{commentSubmitted:commentSubmitted,clearCommentSubmitted:clearCommentSubmitted}),commentEdited&&commentEdited.id===comment.id&&/*#__PURE__*/_jsx(ShowCommentEdited,{commentEdited:commentEdited,clearCommentEdited:clearCommentEdited}),canEdit&&!(editComment&&editComment.id===comment.id)&&/*#__PURE__*/_jsx(\"p\",{className:\"buttons\",children:/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-info btn-sm\",onClick:function onClick(event){event.preventDefault();setEditComment(comment);},children:\"Edit your comment\"})}),confirmDelete&&editComment&&editComment.id===comment.id&&/*#__PURE__*/_jsxs(\"p\",{style:{margin:20,textAlign:\"center\"},children:[/*#__PURE__*/_jsx(\"b\",{children:\"Are you sure?\"}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-danger\",onClick:function onClick(event){event.preventDefault();deleteCommentHandler(comment);},children:\"Yes\"}),\" \",/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-info\",onClick:function onClick(event){event.preventDefault();_this4.setState({confirmDelete:false});},children:\"No\"})]}),canEdit&&editComment&&editComment.id===comment.id&&/*#__PURE__*/_jsxs(\"p\",{className:\"buttons\",children:[!confirmDelete&&/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-warning btn-sm\",onClick:function onClick(event){event.preventDefault();_this4.setState({confirmDelete:true});},children:\"Remove your comment\"}),\" \",/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-info btn-sm\",onClick:function onClick(event){event.preventDefault();if(confirmDelete){_this4.setState({confirmDelete:false},function(){setEditComment(null);});}else{setEditComment(null);}},children:\"Close edit\"})]}),editComment&&editComment.id===comment.id?/*#__PURE__*/_jsx(CommentForm,_objectSpread({focusOnMount:true,editingComment:editingComment,replyingComment:false},_this4.props)):/*#__PURE__*/_jsx(DisplayComment,{highlightComment:highlightComment,canReply:canReply,replyingComment:replyingComment,setReplyComment:setReplyComment,comment:comment,highlit:highlitComment&&highlitComment===comment.id}),replyComment&&comment.id===replyComment.id&&/*#__PURE__*/_jsx(CommentForm,_objectSpread(_objectSpread({},_this4.props),{},{replyingComment:replyingComment,focusOnMount:true})),replies&&/*#__PURE__*/_jsx(ShowCommentsRecursive,_objectSpread(_objectSpread({},_this4.props),{},{comments:replies}))]},comment.id);})});}}]);return ShowCommentsRecursive;}(React.PureComponent);var CommentForm=/*#__PURE__*/function(_React$PureComponent4){_inherits(CommentForm,_React$PureComponent4);var _super4=_createSuper(CommentForm);function CommentForm(){var _this5;_classCallCheck(this,CommentForm);for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}_this5=_super4.call.apply(_super4,[this].concat(args));_this5.state={comment:_this5.props.editComment?_this5.props.editComment.text:\"\",name:\"\",email:\"\",showNameEmailInputs:true,wasSearchedFor:false,canSubmit:false,warnAboutName:false};_this5.textareaRef=/*#__PURE__*/React.createRef();_this5.clearComment=function(){_this5.setState({comment:\"\",preview:false});};_this5.submitHandler=function(event){event.preventDefault();var _this5$state=_this5.state,comment=_this5$state.comment,name=_this5$state.name,email=_this5$state.email,warnAboutName=_this5$state.warnAboutName,wasSearchedFor=_this5$state.wasSearchedFor;var _this5$props=_this5.props,submitCommentHandler=_this5$props.submitCommentHandler,editComment=_this5$props.editComment,replyComment=_this5$props.replyComment;if(!comment.trim()){return;}try{if(name&&name.trim()){localStorage.setItem(\"commentName\",name.trim());}if(email&&email.trim()){localStorage.setItem(\"commentEmail\",email.trim());}}catch(ex){console.warn(\"'localStorage.stItem(\\\"commentName\\\")' didn't work\");}if((!name||!email)&&!warnAboutName){_this5.setState({warnAboutName:true});}else{if(warnAboutName){_this5.setState({warnAboutName:false});}submitCommentHandler({comment:comment,email:email,name:name,wasSearchedFor:wasSearchedFor,editComment:editComment,replyComment:replyComment,askedWasSearchedFor:_this5.askWasSearchedFor()});}};_this5.getTextareaRows=function(text){var minimum=arguments.length>1&&arguments[1]!==undefined?arguments[1]:4;var maximum=arguments.length>2&&arguments[2]!==undefined?arguments[2]:16;var linebreaks=(text.match(/\\n/g)||[]).length;return Math.min(maximum,Math.max(minimum,linebreaks+2));};_this5.askWasSearchedFor=function(){var _this5$props2=_this5.props,searchedId=_this5$props2.searchedId,replyingComment=_this5$props2.replyingComment,hasCommented=_this5$props2.hasCommented,editingComment=_this5$props2.editingComment;return!!(searchedId&&!replyingComment&&!editingComment&&!hasCommented);};return _this5;}_createClass(CommentForm,[{key:\"componentDidMount\",value:function componentDidMount(){var update={};var _this$state4=this.state,canSubmit=_this$state4.canSubmit,name=_this$state4.name,email=_this$state4.email,showNameEmailInputs=_this$state4.showNameEmailInputs;try{name=localStorage.getItem(\"commentName\")||\"\";email=localStorage.getItem(\"commentEmail\")||\"\";}catch(ex){console.warn(\"'localStorage.getItem(\\\"commentName\\\")' didn't work\");}if(name||email){update.name=name;update.email=email;}if(!canSubmit&&(name||email)){update.canSubmit=true;}if(name&&email&&showNameEmailInputs&&!this.props.editComment){update.showNameEmailInputs=false;}if(Object.keys(update).length){this.setState(update);}if(this.props.focusOnMount){// Usually true when doing an edit\nthis.textareaRef.current.focus();}}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.dismounted=true;}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(prevProps.commentSubmitted!==this.props.commentSubmitted){this.setState({comment:\"\"});}}},{key:\"render\",value:function render(){var _this6=this;var _this$state5=this.state,comment=_this$state5.comment,name=_this$state5.name,email=_this$state5.email,warnAboutName=_this$state5.warnAboutName,showNameEmailInputs=_this$state5.showNameEmailInputs;var _this$props6=this.props,editComment=_this$props6.editComment,savingComment=_this$props6.savingComment,submissionError=_this$props6.submissionError,editingComment=_this$props6.editingComment,csrfToken=_this$props6.csrfToken;if(!csrfToken){if(isServer){return/*#__PURE__*/_jsx(\"i\",{children:\"Must have JavaScript enabled to comment.\"});}else{return null;}}return/*#__PURE__*/_jsxs(\"form\",{onSubmit:this.submitHandler,children:[/*#__PURE__*/_jsx(ShowSubmissionError,{submissionError:submissionError}),editingComment&&/*#__PURE__*/_jsxs(\"i\",{children:[\"You can edit \",/*#__PURE__*/_jsx(\"b\",{children:\"your\"}),\" recently added, but not yet approved comments.\"]}),savingComment&&/*#__PURE__*/_jsx(ShowSavingStatus,{}),this.askWasSearchedFor()&&/*#__PURE__*/_jsxs(\"div\",{style:{textAlign:\"center\",marginBottom:20},children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Was this the song you were looking for?\"}),/*#__PURE__*/_jsxs(\"label\",{className:\"radio-inline\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"wasSearchedFor\",value:\"yes\",disabled:savingComment,onChange:function onChange(e){_this6.setState({wasSearchedFor:true},function(){if(_this6.textareaRef.current){_this6.textareaRef.current.focus();}});}}),\" \",\"Yes!\"]}),/*#__PURE__*/_jsxs(\"label\",{className:\"radio-inline\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"wasSearchedFor\",id:\"inlineRadio2\",value:\"no\",disabled:savingComment,onChange:function onChange(e){_this6.setState({wasSearchedFor:false},function(){if(_this6.textareaRef.current){_this6.textareaRef.current.focus();}});}}),\" \",\"No :(\"]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"form-group\",children:/*#__PURE__*/_jsx(\"textarea\",{className:\"form-control\",rows:this.getTextareaRows(this.state.comment),ref:this.textareaRef,value:comment,disabled:savingComment,onChange:function onChange(e){return _this6.setState({comment:e.target.value});},onBlur:function onBlur(event){if(_this6.state.comment.trim()){setTimeout(function(){if(!_this6.dismounted){if(!_this6.state.canSubmit){_this6.setState({canSubmit:true});}}},100);}}})}),showNameEmailInputs&&/*#__PURE__*/_jsxs(\"div\",{className:\"form-inlinexxx\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"_name\",className:\"sr-only\",children:\"Your name\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control\",id:\"_name\",placeholder:\"Your name...\",disabled:savingComment,value:name,onChange:function onChange(e){return _this6.setState({name:e.target.value});}})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",style:{marginBottom:3},children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"_email\",className:\"sr-only\",children:\"Email address\"}),/*#__PURE__*/_jsx(\"input\",{type:\"email\",className:\"form-control\",id:\"_email\",placeholder:\"Your email address...\",disabled:savingComment,value:email,onChange:function onChange(e){return _this6.setState({email:e.target.value});}})]}),/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsxs(\"small\",{children:[\"Your email will \",/*#__PURE__*/_jsx(\"b\",{children:\"never be published\"}),\" and\",\" \",/*#__PURE__*/_jsx(\"b\",{children:\"never be shared\"}),\". Useful to receive reply comments.\"]})})]}),warnAboutName&&/*#__PURE__*/_jsxs(\"div\",{className:\"alert-comment alert alert-warning alert-dismissible\",role:\"alert\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"close\",\"data-dismiss\":\"alert\",\"aria-label\":\"Close\",onClick:function onClick(event){_this6.setState({warnAboutName:false});},children:/*#__PURE__*/_jsx(\"span\",{\"aria-hidden\":\"true\",children:\"\\xD7\"})}),/*#__PURE__*/_jsx(\"p\",{children:name?/*#__PURE__*/_jsx(\"b\",{children:\"Please enter your email\"}):/*#__PURE__*/_jsx(\"b\",{children:\"Please enter your name\"})}),/*#__PURE__*/_jsxs(\"p\",{children:[\"A real name and email helps the comment be approved.\",/*#__PURE__*/_jsx(\"br\",{}),\"An email address makes it possible to receive notification on replies to your comment.\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"row\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"col-md-8\",children:name&&email&&!showNameEmailInputs&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"p\",{children:[\"Commenting as \",/*#__PURE__*/_jsx(\"b\",{children:name}),\". Replies sent to \",/*#__PURE__*/_jsx(\"b\",{children:email}),\".\"]}),/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:\"btn btn-info btn-sm\",onClick:function onClick(event){event.preventDefault();_this6.setState({showNameEmailInputs:true});},children:\"Change name\"})})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"col-md-4\",style:{textAlign:\"right\"},children:/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"btn btn-primary\",disabled:!comment.trim()||savingComment,children:editComment?\"Save Changes\":\"Post Comment\"})})]}),!this.state.wasSearchedFor&&/*#__PURE__*/_jsx(\"p\",{style:{margin:\"20px 0\"},children:/*#__PURE__*/_jsxs(\"small\",{children:[\"Can't find the song you're looking for?\",\" \",/*#__PURE__*/_jsxs(\"a\",{href:\"https://www.peterbe.com/plog/blogitem-040601-1\",children:[\"Try posting on \",/*#__PURE__*/_jsx(\"b\",{children:\"Find song by lyrics\"})]}),\".\"]})})]});}}]);return CommentForm;}(React.PureComponent);function ShowSavingStatus(){return/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"i\",{children:\"Please wait....\"})});}var DisplayComment=/*#__PURE__*/function(_React$PureComponent5){_inherits(DisplayComment,_React$PureComponent5);var _super5=_createSuper(DisplayComment);function DisplayComment(){_classCallCheck(this,DisplayComment);return _super5.apply(this,arguments);}_createClass(DisplayComment,[{key:\"render\",value:function render(){var _this$props7=this.props,highlit=_this$props7.highlit,highlightComment=_this$props7.highlightComment,canReply=_this$props7.canReply,replyingComment=_this$props7.replyingComment,setReplyComment=_this$props7.setReplyComment,comment=_this$props7.comment;var id=comment.id,name=comment.name,created=comment.created;var notApproved=comment.not_approved;var text=comment.text_rendered;function getRandomCelebration(){var emojis=[\"🎉\",\"🎊\",\"🥳\",\"✨\",\"👍🏼\",\"🥰\",\"😍\",\"🍾\"];var emoji=emojis[Math.floor(Math.random()*emojis.length)];return/*#__PURE__*/_jsx(\"span\",{role:\"img\",\"aria-label\":\"muted\",children:emoji});}return/*#__PURE__*/_jsxs(\"div\",{className:highlit?\"display highlit\":\"display\",children:[canReply&&/*#__PURE__*/_jsx(\"p\",{className:\"buttons\",children:/*#__PURE__*/_jsx(\"button\",{type:\"button\",className:replyingComment?\"btn btn-warning btn-sm\":\"btn btn-info btn-sm\",onClick:function onClick(event){event.preventDefault();setReplyComment(comment);},children:replyingComment?\"Close\":\"Reply\"})}),/*#__PURE__*/_jsxs(\"h5\",{children:[\"By \",/*#__PURE__*/_jsx(\"b\",{children:name?name:/*#__PURE__*/_jsx(\"i\",{children:\"Anonymous\"})})]}),/*#__PURE__*/_jsxs(\"p\",{className:\"meta\",children:[/*#__PURE__*/_jsxs(\"a\",{href:\"#c\".concat(id),title:created,onClick:function onClick(event){highlightComment(id);},children:[\"Posted \",/*#__PURE__*/_jsx(CustomTimeAgo,{date:created,title:created})]}),notApproved&&/*#__PURE__*/_jsx(\"small\",{children:\"Not yet approved!\"})]}),comment.hasOwnProperty(\"was_searched_for\")&&/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"i\",{children:\"Was it the song you were looking for?\"}),\" \",/*#__PURE__*/_jsx(\"b\",{children:comment.was_searched_for?\"Yes\":\"No\"}),\" \",comment.was_searched_for&&getRandomCelebration()]}),typeof text===\"string\"?/*#__PURE__*/_jsx(\"blockquote\",{dangerouslySetInnerHTML:{__html:text}}):/*#__PURE__*/_jsx(\"blockquote\",{children:text})]});}}]);return DisplayComment;}(React.PureComponent);","map":{"version":3,"sources":["/home/mandeep/Downloads/Song-sorch work/site/src/Comments.js"],"names":["React","useEffect","useState","cachedFetch","CustomTimeAgo","isServer","Helmet","SUBMITTED_COMMENTS_STORAGE_KEY","SongComments","state","loadingComments","savingComment","serverError","submissionError","comments","props","commentsCount","submittedComments","commentSubmitted","commentEdited","commentDeleted","searchedId","replyComment","editComment","csrfToken","highlightComment","highlitComment","hasCommented","loadCSRFToken","url","fetch","then","r","dismounted","ok","json","result","setState","csrf_token","catch","error","loadComments","song","search","submittedCommentIds","id","length","filter","submission","map","forEach","includes","fetchFunc","comments_count","consolidateSubmittedComments","recurse","comment","not_approved","submittedComment","removeSubmittedComments","push","newSubmittedComments","sessionStorage","setItem","JSON","stringify","ex","console","warn","removeItem","window","setTimeout","submitCommentHandler","data","_submitCommentHandler","Error","formData","FormData","append","name","email","oid","askedWasSearchedFor","wasSearchedFor","parent","experiment","method","body","response","localStorage","submitted","document","querySelectorAll","querySelector","scrollIntoView","behavior","slice","o","toPush","deleteCommentHandler","_deleteCommentHandler","filteredSubmittedComments","setEditComment","setReplyComment","clearCommentSubmitted","clearCommentEdited","clearCommentDeleted","submittedCommentStorage","getItem","parse","some","location","hash","re","match","parseInt","element","prevProps","Typekit","load","async","artist","PureComponent","ShowCommentSubmitted","event","ShowCommentEdited","ShowCommentDeleted","ShowSubmissionError","validationErrors","setValidationErrors","isErrorResponse","Response","err","log","status","errors","errorMessage","Object","keys","key","message","code","toString","ShowComments","ShowCommentsRecursive","confirmDelete","allComments","canEdit","c","canReply","replies","editingComment","replyingComment","preventDefault","margin","textAlign","CommentForm","text","showNameEmailInputs","canSubmit","warnAboutName","textareaRef","createRef","clearComment","preview","submitHandler","trim","askWasSearchedFor","getTextareaRows","minimum","maximum","linebreaks","Math","min","max","update","focusOnMount","current","focus","marginBottom","e","target","value","ShowSavingStatus","DisplayComment","highlit","created","notApproved","text_rendered","getRandomCelebration","emojis","emoji","floor","random","hasOwnProperty","was_searched_for","__html"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { cachedFetch } from \"./Cache\";\nimport { CustomTimeAgo, isServer } from \"./Common\";\nimport \"./Comments.css\";\nimport { Helmet } from \"react-helmet\";  \n\n\nconst SUBMITTED_COMMENTS_STORAGE_KEY = \"submittedComments\";\n\nexport class SongComments extends React.PureComponent {\n  state = {\n    loadingComments: false,\n    savingComment: false,\n    serverError: null,\n    submissionError: null,\n    comments: this.props.comments || null,\n    commentsCount: this.props.commentsCount || null,\n    submittedComments: [],\n    commentSubmitted: null,\n    commentEdited: null,\n    commentDeleted: null,\n    searchedId: this.props.searchedId,\n    replyComment: null,\n    editComment: null,\n    csrfToken: null,\n    highlightComment: null,\n    highlitComment: null,\n    hasCommented: false\n  };\n\n  componentDidMount() {\n    // If you're here, you're a browser and no a server rendering.\n    let submittedCommentStorage = \"[]\";\n    try {\n      submittedCommentStorage =\n        sessionStorage.getItem(SUBMITTED_COMMENTS_STORAGE_KEY) || \"[]\";\n    } catch (ex) {\n      console.warn(\n        \"'sessionStorage.getItem(SUBMITTED_COMMENTS_STORAGE_KEY)' didn't work\"\n      );\n    }\n    const submittedComments = JSON.parse(submittedCommentStorage);\n    if (submittedComments.length) {\n      // Definitely load comments. Even if you arrived here with the comments\n      // already server-side rendered.\n      // Because, this call to loadingComments might be potentially different.\n\n      // If you have commented on this song before, update that in state.\n      let hasCommented = false;\n      const { song } = this.props;\n      if (song) {\n        hasCommented = submittedComments.some(\n          (comment) => comment.song && comment.song === song.id\n        );\n      }\n\n      this.setState(\n        {\n          submittedComments,\n          hasCommented,\n          loadingComments: !this.state.comments\n        },\n        this.loadComments\n      );\n    } else {\n      // If the comments were already loaded, we only need the csrfToken.\n      if (!this.state.comments) {\n        this.setState({ loadingComments: true }, this.loadComments);\n      } else {\n        // We just need a new csrfToken\n        this.loadCSRFToken();\n      }\n    }\n\n    if (window.location.hash) {\n      const re = /c(\\d+)$/;\n      if (window.location.hash.match(re)) {\n        const id = parseInt(window.location.hash.match(re)[1], 10);\n        this.setState({ highlitComment: id }, () => {\n          window.setTimeout(() => {\n            if (!this.dismounted) {\n              const element = document.querySelector(\n                `#c${this.state.highlitComment}`\n              );\n              if (element && element.scrollIntoView) {\n                element.scrollIntoView({\n                  behavior: \"smooth\"\n                });\n              }\n            }\n          }, 1000);\n\n          window.setTimeout(() => {\n            if (!this.dismounted && this.state.highlitComment === id) {\n              this.setState({ highlitComment: null });\n            }\n          }, 10 * 1000);\n        });\n      }\n    }\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.song !== this.props.song) {\n      this.setState(\n        { loadingComments: true, comments: null, commentsCount: null },\n        this.loadComments\n      );\n    }\n  }\n\n  componentWillUnmount() {\n    this.dismounted = true;\n  }\n\n  loadCSRFToken = () => {\n    let url = \"/api/comments?csrftoken=1\";\n    fetch(url)\n      .then((r) => {\n        if (this.dismounted) return;\n        if (r.ok) {\n          return r.json().then((result) => {\n            this.setState({\n              csrfToken: result.csrf_token\n            });\n          });\n        } else {\n          this.setState({ serverError: r });\n        }\n      })\n      .catch((error) => {\n        if (this.dismounted) return;\n        this.setState({ serverError: error });\n      });\n  };\n\n  loadComments = () => {\n    const { song, search } = this.props;\n    const { submittedComments, commentEdited } = this.state;\n    let submittedCommentIds = [];\n    let url = \"/api/comments\";\n    if (song) {\n      url += `?song=${song.id}`;\n    } else if (search) {\n      url += `?search=${search.id}`;\n    } else {\n      // throw new Error(\"Don't know how to do this outside of song\");\n    }\n\n    if (submittedComments.length) {\n      submittedCommentIds = submittedComments\n        .filter((submission) => {\n          if (song) {\n            return submission.song === song.id;\n          } else if (search) {\n            return submission.search === search.id;\n          } else {\n            return !submission.song && !submission.search;\n          }\n        })\n        .map((submission) => submission.id);\n    }\n\n    submittedCommentIds.forEach((id) => {\n      url += url.includes(\"?\") ? \"&\" : \"?\";\n      url += `submitted=${id}`;\n    });\n\n    if (commentEdited) {\n      // Just to extra-bust the cache\n      url += url.includes(\"?\") ? \"&\" : \"?\";\n      url += `edited=${commentEdited.id}`;\n    }\n\n    let fetchFunc;\n    if (commentEdited && submittedCommentIds.length) {\n      // Don't use the caching one\n      fetchFunc = fetch;\n    } else {\n      fetchFunc = cachedFetch;\n    }\n\n    fetchFunc(url)\n      .then((r) => {\n        if (this.dismounted) return;\n        this.setState({ loadingComments: false });\n        if (r.ok) {\n          return r.json().then((result) => {\n            this.setState(\n              {\n                csrfToken: result.csrf_token,\n                comments: result.comments,\n                commentsCount: result.comments_count,\n                loadingComments: false\n              },\n              this.consolidateSubmittedComments\n            );\n          });\n        } else {\n          this.setState({ serverError: r, loadingComments: false });\n        }\n      })\n      .catch((error) => {\n        if (this.dismounted) return;\n        this.setState({ serverError: error, loadingComments: false });\n      });\n  };\n\n  consolidateSubmittedComments = () => {\n    const { comments } = this.state;\n    let { submittedComments } = this.state;\n    if (submittedComments.length && comments[\"\"] && comments[\"\"].length) {\n      // If any of your submitted comments is now approved, we need to remove\n      // it from sessionStorage.\n      const removeSubmittedComments = [];\n      function recurse(comments) {\n        comments.forEach((comment) => {\n          if (!comment.not_approved) {\n            // Add to removeSubmittedComments only if this is one of the ones\n            // you submitted.\n            submittedComments.forEach((submittedComment) => {\n              if (submittedComment.id === comment.id) {\n                removeSubmittedComments.push(submittedComment.id);\n              }\n            });\n          }\n          if (comments[comment.id]) {\n            recurse(comments[comment.id]);\n          }\n        });\n      }\n      recurse(comments[\"\"]);\n\n      if (removeSubmittedComments.length) {\n        const newSubmittedComments = submittedComments.filter(\n          (submittedComment) => {\n            return !removeSubmittedComments.includes(submittedComment.id);\n          }\n        );\n        this.setState({ submittedComments: newSubmittedComments }, () => {\n          if (this.state.submittedComments.length) {\n            // Update\n            try {\n              sessionStorage.setItem(\n                SUBMITTED_COMMENTS_STORAGE_KEY,\n                JSON.stringify(this.state.submittedComments)\n              );\n            } catch (ex) {\n              console.warn(\n                \"'sessionStorage.setItem(SUBMITTED_COMMENTS_STORAGE_KEY)' did't work\"\n              );\n            }\n          } else {\n            // Reset\n            try {\n              sessionStorage.removeItem(SUBMITTED_COMMENTS_STORAGE_KEY);\n            } catch (ex) {}\n          }\n        });\n      }\n    }\n  };\n\n  highlightComment = (id) => {\n    let { highlitComment } = this.state;\n    if (highlitComment && highlitComment === id) {\n      highlitComment = null;\n    } else {\n      highlitComment = id;\n    }\n    this.setState({ highlitComment }, () => {\n      window.setTimeout(() => {\n        if (!this.dismounted && this.state.highlitComment === id) {\n          this.setState({ highlitComment: null });\n        }\n      }, 10 * 1000);\n    });\n  };\n\n  submitCommentHandler = (data) => {\n    this.setState({ savingComment: true }, () => {\n      this._submitCommentHandler(data).then(() => {\n        this.setState({ savingComment: false });\n      });\n    });\n  };\n  _submitCommentHandler = async (data) => {\n    let response;\n    const { song, search } = this.props;\n    const { submittedComments, csrfToken } = this.state;\n    if (!csrfToken) {\n      throw new Error(\"No csrfToken prepared\");\n    }\n    const formData = new FormData();\n    formData.append(\"csrfmiddlewaretoken\", csrfToken);\n    formData.append(\"text\", data.comment);\n    formData.append(\"name\", data.name);\n    formData.append(\"email\", data.email);\n\n    if (submittedComments.length) {\n      submittedComments\n        .filter((submission) => {\n          if (song) {\n            return submission.song === song.id;\n          } else if (search) {\n            return submission.search === search.id;\n          } else {\n            return !submission.song && !submission.search;\n          }\n        })\n        .forEach((submission) => {\n          formData.append(\"submitted\", submission.id);\n        });\n    }\n\n    if (data.editComment) {\n      formData.append(\"id\", data.editComment.id);\n      if (!data.editComment.oid) {\n        throw new Error(\"Can't edit if you don't have the oid\");\n      }\n      formData.append(\"oid\", data.editComment.oid);\n    }\n    if (data.replyComment) {\n      formData.append(\"parent\", data.replyComment.id);\n    }\n    if (data.askedWasSearchedFor) {\n      formData.append(\"was_searched_for\", data.wasSearchedFor || false);\n    }\n    if (this.state.searchedId) {\n      formData.append(\"search\", this.state.searchedId || null);\n    }\n    if (data.parent) {\n      formData.append(\"parent\", data.parent || null);\n    }\n    formData.append(\"experiment\", data.experiment || {});\n\n    if (song) {\n      formData.append(\"song\", song.id);\n    } else if (search) {\n      formData.append(\"search\", search.id);\n    } else {\n      // throw new Error(\"Don't know how to do this outside of song\");\n    }\n\n    try {\n      response = await fetch(\"/api/comments\", {\n        method: \"POST\",\n        body: formData\n      });\n      if (response.ok) {\n        // If posted a comment because this *was* the song you\n        // searched for, let's kill that not to stop asking that question.\n        if (this.state.searchedId) {\n          try {\n            localStorage.removeItem(\"searched\");\n          } catch (ex) {\n            console.warn(\"'localStorage.removeItem(\\\"searched\\\")' didn't work\");\n          }\n        }\n\n        const result = await response.json();\n\n        if (data.editComment) {\n          return this.setState({\n            searchedId: null,\n            commentEdited: result.submitted,\n            submissionError: null,\n            commentSubmitted: null,\n            editComment: null,\n            replyComment: null,\n            comments: result.comments,\n            commentsCount: result.comments_count\n          });\n        } else {\n          return this.setState(\n            {\n              searchedId: null,\n              submissionError: null,\n              commentEdited: null,\n              commentSubmitted: result.submitted,\n              commentDeleted: null,\n              replyComment: null,\n              comments: result.comments,\n              commentsCount: result.comments_count\n            },\n            () => {\n              // Only do this if there is only exactly 1 of these in the DOM.\n              // The reason why is that when repeatedly injecting the <SongComments>\n              // components in multiple places, you might have different ones\n              // for different expanded songs.\n              if (document.querySelectorAll(\".alert-comment\").length === 1) {\n                document\n                  .querySelector(\".alert-comment.alert-success\")\n                  .scrollIntoView({ behavior: \"smooth\" });\n              }\n\n              const { commentSubmitted } = this.state;\n              const { song, search } = this.props;\n\n              this.highlightComment(commentSubmitted.id);\n\n              const submittedComments = this.state.submittedComments.slice(0);\n              // If you accidentally double-clicked to submit twice.\n              // Or, just wrote the exact same comment twice, the server\n              // won't create another record but it will respond as if it worked\n              // so we need to check first that we don't already have\n              // this 'commentSubmitted.id` already.\n              if (\n                !submittedComments\n                  .map((o) => o.id)\n                  .filter((id) => id === commentSubmitted.id).length\n              ) {\n                const toPush = {\n                  id: commentSubmitted.id,\n                  oid: commentSubmitted.oid\n                };\n                if (song) {\n                  toPush.song = song.id;\n                } else if (search) {\n                  toPush.search = search.id;\n                }\n                submittedComments.push(toPush);\n              }\n              this.setState(\n                { submittedComments, submissionError: null },\n                () => {\n                  this.loadComments();\n                  try {\n                    sessionStorage.setItem(\n                      SUBMITTED_COMMENTS_STORAGE_KEY,\n                      JSON.stringify(this.state.submittedComments)\n                    );\n                  } catch (ex) {}\n                }\n              );\n            }\n          );\n        }\n      } else {\n        return this.setState({ submissionError: response });\n      }\n    } catch (error) {\n      console.warn(\"Submission failed:\", error);\n      return this.setState({ submissionError: error });\n    }\n  };\n\n  deleteCommentHandler = (comment) => {\n    this.setState({ savingComment: true }, () => {\n      this._deleteCommentHandler(comment).then(() => {\n        this.setState({ savingComment: false });\n      });\n    });\n  };\n\n  _deleteCommentHandler = async (comment) => {\n    let response;\n    const formData = new FormData();\n    if (!comment.oid) {\n      throw new Error(\"Can't edit if you don't have the oid\");\n    }\n    formData.append(\"id\", comment.id);\n    formData.append(\"oid\", comment.oid);\n    const url = \"/api/comments/delete\";\n    try {\n      response = await fetch(url, {\n        method: \"POST\",\n        body: formData\n      });\n    } catch (ex) {\n      return this.setState({ submissionError: ex });\n    }\n    if (!response.ok) {\n      return this.setState({ submissionError: response });\n    }\n    return this.setState(\n      {\n        commentDeleted: comment,\n        commentEdited: null,\n        editComment: null,\n        submissionError: null\n      },\n      () => {\n        // Before we load comments, remove this one from localStorage\n        const submittedComments = this.state.submittedComments;\n        const filteredSubmittedComments = submittedComments.filter(\n          (submission) => submission.id !== comment.id\n        );\n        this.setState({ submittedComments: filteredSubmittedComments }, () => {\n          this.loadComments();\n          try {\n            sessionStorage.setItem(\n              SUBMITTED_COMMENTS_STORAGE_KEY,\n              JSON.stringify(this.state.submittedComments)\n            );\n          } catch (ex) {}\n        });\n      }\n    );\n  };\n\n  setEditComment = (comment) => {\n    this.setState({ editComment: comment });\n  };\n\n  setReplyComment = (comment) => {\n    if (this.state.replyComment && this.state.replyComment.id === comment.id) {\n      this.setState({\n        replyComment: null,\n        highlitComment: null,\n        commentEdited: null\n      });\n    } else {\n      this.setState({\n        replyComment: comment,\n        highlitComment: comment.id,\n        commentEdited: null\n      });\n    }\n  };\n\n  clearCommentSubmitted = () => {\n    this.setState({ commentSubmitted: null });\n  };\n\n  clearCommentEdited = () => {\n    this.setState({ commentEdited: null });\n  };\n\n  clearCommentDeleted = () => {\n    this.setState({ commentDeleted: null });\n  };\n\n  render() {\n    const { song } = this.props;\n    const {\n      comments,\n      commentsCount,\n      submissionError,\n      commentSubmitted,\n      commentEdited,\n      commentDeleted,\n      submittedComments,\n      searchedId,\n      editComment,\n      replyComment,\n      savingComment,\n      highlitComment,\n      hasCommented,\n      csrfToken\n    } = this.state;\n\n    return (\n      \n      <div className=\"comments masters song-comments\">\n             <div className=\"application\">\n             <Helmet>  \n             <script type=\"text/javascript\" language=\"javascript\" src=\"https://live.primis.tech/live/liveView.php?s=113482\"></script>\n             <script>try{Typekit.load({ async: true })} catch(e){}</script>\n             </Helmet>  \n             </div> \n             \n        <h3>\n          Song Comments {commentsCount ? <span>({commentsCount})</span> : null}\n          <br />\n          <small>\n            On <b>{song.name}</b> <span className=\"by\">by</span>{\" \"}\n            {song.artist.name}\n          </small>\n        </h3>\n\n        <ShowCommentDeleted\n          commentDeleted={commentDeleted}\n          clearCommentDeleted={this.clearCommentDeleted}\n        />\n\n        <ShowComments\n          {...this.props}\n          submissionError={submissionError}\n          comments={comments}\n          editComment={editComment}\n          replyComment={replyComment}\n          searchedId={searchedId}\n          setEditComment={this.setEditComment}\n          setReplyComment={this.setReplyComment}\n          submitCommentHandler={this.submitCommentHandler}\n          deleteCommentHandler={this.deleteCommentHandler}\n          commentSubmitted={commentSubmitted}\n          commentEdited={commentEdited}\n          submittedComments={submittedComments}\n          savingComment={savingComment}\n          highlitComment={highlitComment}\n          highlightComment={this.highlightComment}\n          clearCommentSubmitted={this.clearCommentSubmitted}\n          clearCommentEdited={this.clearCommentEdited}\n          csrfToken={csrfToken}\n          hasCommented={hasCommented}\n        />\n      </div>\n    );\n  }\n}\n\nfunction ShowCommentSubmitted({ commentSubmitted, clearCommentSubmitted }) {\n  if (!commentSubmitted) return null;\n  return (\n    <div\n      className=\"alert-comment alert-comment alert alert-success alert-dismissible\"\n      role=\"alert\"\n    >\n      <button\n        type=\"button\"\n        className=\"close\"\n        data-dismiss=\"alert\"\n        aria-label=\"Close\"\n        onClick={(event) => {\n          clearCommentSubmitted();\n        }}\n      >\n        <span aria-hidden=\"true\">&times;</span>\n      </button>\n      <p>\n        <b>Comment submitted. Thank you!</b>\n      </p>\n      <p>It needs to be moderated before publishing.</p>\n    </div>\n  );\n}\n\nfunction ShowCommentEdited({ commentEdited, clearCommentEdited }) {\n  if (!commentEdited) return null;\n  return (\n    <div\n      className=\"alert-comment alert alert-success alert-dismissible\"\n      role=\"alert\"\n    >\n      <button\n        type=\"button\"\n        className=\"close\"\n        data-dismiss=\"alert\"\n        aria-label=\"Close\"\n        onClick={(event) => {\n          clearCommentEdited();\n        }}\n      >\n        <span aria-hidden=\"true\">&times;</span>\n      </button>\n      <p>\n        <b>Comment edited.</b>\n      </p>\n      <p>You can keep editing it until it gets approved.</p>\n    </div>\n  );\n}\n\nfunction ShowCommentDeleted({ commentDeleted, clearCommentDeleted }) {\n  if (!commentDeleted) return null;\n  return (\n    <div\n      className=\"alert-comment alert alert-success alert-dismissible\"\n      role=\"alert\"\n    >\n      <button\n        type=\"button\"\n        className=\"close\"\n        data-dismiss=\"alert\"\n        aria-label=\"Close\"\n        onClick={(event) => {\n          clearCommentDeleted();\n        }}\n      >\n        <span aria-hidden=\"true\">&times;</span>\n      </button>\n      <p>\n        <b>Comment removed.</b>\n      </p>\n      <p>Feel free to write a new comment.</p>\n    </div>\n  );\n}\n\nfunction ShowSubmissionError({ submissionError }) {\n  const [validationErrors, setValidationErrors] = useState({});\n\n  let isErrorResponse = false;\n  if (!isServer) {\n    try {\n      isErrorResponse = submissionError instanceof window.Response;\n    } catch (err) {\n      // Old browsers. E.g. Firefox 38.\n      console.log(\"instanceof window.Response did not work:\", err);\n    }\n  }\n\n  useEffect(() => {\n    if (!isServer && isErrorResponse && submissionError.status === 400) {\n      submissionError.json().then((data) => {\n        setValidationErrors(data.errors);\n      });\n    }\n  }, [submissionError, isErrorResponse]);\n\n  if (!submissionError) return null;\n\n  let errorMessage;\n  if (!isServer && isErrorResponse) {\n    if (submissionError.status === 400) {\n      errorMessage = (\n        <div>\n          <p>\n            <b>Something's not right with the submission</b>\n          </p>\n          {Object.keys(validationErrors).map((key) => {\n            return (\n              <p key={key}>\n                <b>{key}:</b>{\" \"}\n                {validationErrors[key].map((err) => (\n                  <span key={err.message + err.code}>\n                    <i>{err.message}</i>{\" \"}\n                    {err.code ? (\n                      <span>\n                        (<code>{err.code}</code>)\n                      </span>\n                    ) : null}\n                  </span>\n                ))}\n              </p>\n            );\n          })}\n        </div>\n      );\n    } else if (submissionError.status >= 500) {\n      errorMessage = (\n        <p>Server error. Perhaps simply try again a little later.</p>\n      );\n    } else {\n      errorMessage = (\n        <p>The server basically failed to process the submission.</p>\n      );\n    }\n  } else {\n    errorMessage = (\n      <p>\n        <code>{submissionError.toString()}</code>\n      </p>\n    );\n  }\n\n  return (\n    <div className=\"search-error\">\n      <h4>Sorry, an error occured</h4>\n      {errorMessage}\n    </div>\n  );\n}\n\nclass ShowComments extends React.PureComponent {\n  render() {\n    const { comments, replyComment, editComment } = this.props;\n    return (\n      <>\n        {comments && comments[\"\"] && (\n          <ShowCommentsRecursive\n            {...this.props}\n            allComments={comments}\n            comments={comments[\"\"]}\n          />\n        )}\n        {!replyComment && !editComment && (\n          <CommentForm replyingComment={false} {...this.props} />\n        )}\n      </>\n    );\n  }\n}\n\nclass ShowCommentsRecursive extends React.PureComponent {\n  state = {\n    confirmDelete: false\n  };\n\n  render() {\n    const { confirmDelete } = this.state;\n    const {\n      replyComment,\n      editComment,\n      setEditComment,\n      setReplyComment,\n      comments,\n      allComments,\n      submittedComments,\n      deleteCommentHandler,\n      highlightComment,\n      highlitComment,\n      commentSubmitted,\n      clearCommentSubmitted,\n      commentEdited,\n      clearCommentEdited,\n      csrfToken\n    } = this.props;\n    if (!comments.length) return null;\n\n    return (\n      <div className=\"comments\">\n        {comments.map((comment) => {\n          // You're allowed to edit it if it was yours and it's not approved yet.\n          let canEdit = false;\n          if (comment.not_approved) {\n            // Take 'editComment' into account\n            if (submittedComments.filter((c) => c.id === comment.id).length) {\n              canEdit = true;\n            }\n          }\n          let canReply = !canEdit && csrfToken;\n\n          const replies = allComments[comment.id];\n\n          const editingComment = !!(\n            canEdit &&\n            editComment &&\n            editComment.id === comment.id\n          );\n\n          const replyingComment = !!(\n            canReply &&\n            replyComment &&\n            replyComment.id === comment.id\n          );\n\n          return (\n            <div className=\"comment\" key={comment.id} id={`c${comment.id}`}>\n              {commentSubmitted && commentSubmitted.id === comment.id && (\n                <ShowCommentSubmitted\n                  commentSubmitted={commentSubmitted}\n                  clearCommentSubmitted={clearCommentSubmitted}\n                />\n              )}\n\n              {commentEdited && commentEdited.id === comment.id && (\n                <ShowCommentEdited\n                  commentEdited={commentEdited}\n                  clearCommentEdited={clearCommentEdited}\n                />\n              )}\n\n              {canEdit && !(editComment && editComment.id === comment.id) && (\n                <p className=\"buttons\">\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-info btn-sm\"\n                    onClick={(event) => {\n                      event.preventDefault();\n                      setEditComment(comment);\n                    }}\n                  >\n                    Edit your comment\n                  </button>\n                </p>\n              )}\n\n              {confirmDelete && editComment && editComment.id === comment.id && (\n                <p style={{ margin: 20, textAlign: \"center\" }}>\n                  <b>Are you sure?</b>\n                  <br />\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-danger\"\n                    onClick={(event) => {\n                      event.preventDefault();\n                      deleteCommentHandler(comment);\n                    }}\n                  >\n                    Yes\n                  </button>{\" \"}\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-info\"\n                    onClick={(event) => {\n                      event.preventDefault();\n                      this.setState({ confirmDelete: false });\n                    }}\n                  >\n                    No\n                  </button>\n                </p>\n              )}\n\n              {canEdit && editComment && editComment.id === comment.id && (\n                <p className=\"buttons\">\n                  {!confirmDelete && (\n                    <button\n                      type=\"button\"\n                      className=\"btn btn-warning btn-sm\"\n                      onClick={(event) => {\n                        event.preventDefault();\n                        this.setState({ confirmDelete: true });\n                      }}\n                    >\n                      Remove your comment\n                    </button>\n                  )}{\" \"}\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-info btn-sm\"\n                    onClick={(event) => {\n                      event.preventDefault();\n                      if (confirmDelete) {\n                        this.setState({ confirmDelete: false }, () => {\n                          setEditComment(null);\n                        });\n                      } else {\n                        setEditComment(null);\n                      }\n                    }}\n                  >\n                    Close edit\n                  </button>\n                </p>\n              )}\n\n              {editComment && editComment.id === comment.id ? (\n                <CommentForm\n                  focusOnMount={true}\n                  editingComment={editingComment}\n                  replyingComment={false}\n                  {...this.props}\n                />\n              ) : (\n                <DisplayComment\n                  highlightComment={highlightComment}\n                  canReply={canReply}\n                  replyingComment={replyingComment}\n                  setReplyComment={setReplyComment}\n                  comment={comment}\n                  highlit={highlitComment && highlitComment === comment.id}\n                />\n              )}\n\n              {replyComment && comment.id === replyComment.id && (\n                <CommentForm\n                  {...this.props}\n                  replyingComment={replyingComment}\n                  focusOnMount={true}\n                />\n              )}\n              {replies && (\n                <ShowCommentsRecursive {...this.props} comments={replies} />\n              )}\n            </div>\n          );\n        })}\n      </div>\n    );\n  }\n}\n\nclass CommentForm extends React.PureComponent {\n  state = {\n    comment: this.props.editComment ? this.props.editComment.text : \"\",\n    name: \"\",\n    email: \"\",\n    showNameEmailInputs: true,\n    wasSearchedFor: false,\n    canSubmit: false,\n    warnAboutName: false\n  };\n\n  textareaRef = React.createRef();\n\n  componentDidMount() {\n    const update = {};\n\n    let { canSubmit, name, email, showNameEmailInputs } = this.state;\n\n    try {\n      name = localStorage.getItem(\"commentName\") || \"\";\n      email = localStorage.getItem(\"commentEmail\") || \"\";\n    } catch (ex) {\n      console.warn(\"'localStorage.getItem(\\\"commentName\\\")' didn't work\");\n    }\n\n    if (name || email) {\n      update.name = name;\n      update.email = email;\n    }\n\n    if (!canSubmit && (name || email)) {\n      update.canSubmit = true;\n    }\n    if (name && email && showNameEmailInputs && !this.props.editComment) {\n      update.showNameEmailInputs = false;\n    }\n\n    if (Object.keys(update).length) {\n      this.setState(update);\n    }\n\n    if (this.props.focusOnMount) {\n      // Usually true when doing an edit\n      this.textareaRef.current.focus();\n    }\n  }\n  componentWillUnmount() {\n    this.dismounted = true;\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.commentSubmitted !== this.props.commentSubmitted) {\n      this.setState({ comment: \"\" });\n    }\n  }\n\n  clearComment = () => {\n    this.setState({\n      comment: \"\",\n      preview: false\n    });\n  };\n\n  submitHandler = (event) => {\n    event.preventDefault();\n    const { comment, name, email, warnAboutName, wasSearchedFor } = this.state;\n    const { submitCommentHandler, editComment, replyComment } = this.props;\n\n    if (!comment.trim()) {\n      return;\n    }\n    try {\n      if (name && name.trim()) {\n        localStorage.setItem(\"commentName\", name.trim());\n      }\n      if (email && email.trim()) {\n        localStorage.setItem(\"commentEmail\", email.trim());\n      }\n    } catch (ex) {\n      console.warn(\"'localStorage.stItem(\\\"commentName\\\")' didn't work\");\n    }\n\n    if ((!name || !email) && !warnAboutName) {\n      this.setState({ warnAboutName: true });\n    } else {\n      if (warnAboutName) {\n        this.setState({ warnAboutName: false });\n      }\n      submitCommentHandler({\n        comment,\n        email,\n        name,\n        wasSearchedFor,\n        editComment,\n        replyComment,\n        askedWasSearchedFor: this.askWasSearchedFor()\n      });\n    }\n  };\n\n  getTextareaRows = (text, minimum = 4, maximum = 16) => {\n    const linebreaks = (text.match(/\\n/g) || []).length;\n    return Math.min(maximum, Math.max(minimum, linebreaks + 2));\n  };\n\n  askWasSearchedFor = () => {\n    const { searchedId, replyingComment, hasCommented, editingComment } =\n      this.props;\n    return !!(\n      searchedId &&\n      !replyingComment &&\n      !editingComment &&\n      !hasCommented\n    );\n  };\n\n  render() {\n    const { comment, name, email, warnAboutName, showNameEmailInputs } =\n      this.state;\n    const {\n      editComment,\n      savingComment,\n      submissionError,\n      editingComment,\n      csrfToken\n    } = this.props;\n\n    if (!csrfToken) {\n      if (isServer) {\n        return <i>Must have JavaScript enabled to comment.</i>;\n      } else {\n        return null;\n      }\n    }\n\n    return (\n      <form onSubmit={this.submitHandler}>\n        <ShowSubmissionError submissionError={submissionError} />\n\n        {editingComment && (\n          <i>\n            You can edit <b>your</b> recently added, but not yet approved\n            comments.\n          </i>\n        )}\n\n        {savingComment && <ShowSavingStatus />}\n\n        {this.askWasSearchedFor() && (\n          <div style={{ textAlign: \"center\", marginBottom: 20 }}>\n            <h4>Was this the song you were looking for?</h4>\n\n            <label className=\"radio-inline\">\n              <input\n                type=\"radio\"\n                name=\"wasSearchedFor\"\n                value=\"yes\"\n                disabled={savingComment}\n                onChange={(e) => {\n                  this.setState({ wasSearchedFor: true }, () => {\n                    if (this.textareaRef.current) {\n                      this.textareaRef.current.focus();\n                    }\n                  });\n                }}\n              />{\" \"}\n              Yes!\n            </label>\n            <label className=\"radio-inline\">\n              <input\n                type=\"radio\"\n                name=\"wasSearchedFor\"\n                id=\"inlineRadio2\"\n                value=\"no\"\n                disabled={savingComment}\n                onChange={(e) => {\n                  this.setState({ wasSearchedFor: false }, () => {\n                    if (this.textareaRef.current) {\n                      this.textareaRef.current.focus();\n                    }\n                  });\n                }}\n              />{\" \"}\n              No :(\n            </label>\n          </div>\n        )}\n        <div className=\"form-group\">\n          <textarea\n            className=\"form-control\"\n            rows={this.getTextareaRows(this.state.comment)}\n            ref={this.textareaRef}\n            value={comment}\n            disabled={savingComment}\n            onChange={(e) => this.setState({ comment: e.target.value })}\n            onBlur={(event) => {\n              if (this.state.comment.trim()) {\n                setTimeout(() => {\n                  if (!this.dismounted) {\n                    if (!this.state.canSubmit) {\n                      this.setState({ canSubmit: true });\n                    }\n                  }\n                }, 100);\n              }\n            }}\n          />\n        </div>\n        {showNameEmailInputs && (\n          <div className=\"form-inlinexxx\">\n            <div className=\"form-group\">\n              <label htmlFor=\"_name\" className=\"sr-only\">\n                Your name\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"_name\"\n                placeholder=\"Your name...\"\n                disabled={savingComment}\n                value={name}\n                onChange={(e) => this.setState({ name: e.target.value })}\n              />\n            </div>\n\n            <div className=\"form-group\" style={{ marginBottom: 3 }}>\n              <label htmlFor=\"_email\" className=\"sr-only\">\n                Email address\n              </label>\n              <input\n                type=\"email\"\n                className=\"form-control\"\n                id=\"_email\"\n                placeholder=\"Your email address...\"\n                disabled={savingComment}\n                value={email}\n                onChange={(e) => this.setState({ email: e.target.value })}\n              />\n            </div>\n            <p>\n              <small>\n                Your email will <b>never be published</b> and{\" \"}\n                <b>never be shared</b>. Useful to receive reply comments.\n              </small>\n            </p>\n          </div>\n        )}\n        {warnAboutName && (\n          <div\n            className=\"alert-comment alert alert-warning alert-dismissible\"\n            role=\"alert\"\n          >\n            <button\n              type=\"button\"\n              className=\"close\"\n              data-dismiss=\"alert\"\n              aria-label=\"Close\"\n              onClick={(event) => {\n                this.setState({ warnAboutName: false });\n              }}\n            >\n              <span aria-hidden=\"true\">&times;</span>\n            </button>\n            <p>\n              {name ? (\n                <b>Please enter your email</b>\n              ) : (\n                <b>Please enter your name</b>\n              )}\n            </p>\n            <p>\n              A real name and email helps the comment be approved.\n              <br />\n              An email address makes it possible to receive notification on\n              replies to your comment.\n            </p>\n          </div>\n        )}\n        <div className=\"row\">\n          <div className=\"col-md-8\">\n            {name && email && !showNameEmailInputs && (\n              <>\n                <p>\n                  Commenting as <b>{name}</b>. Replies sent to <b>{email}</b>.\n                </p>\n                <p>\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-info btn-sm\"\n                    onClick={(event) => {\n                      event.preventDefault();\n                      this.setState({ showNameEmailInputs: true });\n                    }}\n                  >\n                    Change name\n                  </button>\n                </p>\n              </>\n            )}\n          </div>\n\n          <div className=\"col-md-4\" style={{ textAlign: \"right\" }}>\n            <button\n              type=\"submit\"\n              className=\"btn btn-primary\"\n              disabled={!comment.trim() || savingComment}\n            >\n              {editComment ? \"Save Changes\" : \"Post Comment\"}\n            </button>\n          </div>\n        </div>\n\n        {!this.state.wasSearchedFor && (\n          <p style={{ margin: \"20px 0\" }}>\n            <small>\n              Can't find the song you're looking for?{\" \"}\n              <a href=\"https://www.peterbe.com/plog/blogitem-040601-1\">\n                Try posting on <b>Find song by lyrics</b>\n              </a>\n              .\n            </small>\n          </p>\n        )}\n      </form>\n    );\n  }\n}\n\nfunction ShowSavingStatus() {\n  return (\n    <p>\n      <i>Please wait....</i>\n    </p>\n  );\n}\n\nclass DisplayComment extends React.PureComponent {\n  render() {\n    const {\n      highlit,\n      highlightComment,\n      canReply,\n      replyingComment,\n      setReplyComment,\n      comment\n    } = this.props;\n    const { id, name, created } = comment;\n    const notApproved = comment.not_approved;\n    const text = comment.text_rendered;\n\n    function getRandomCelebration() {\n      const emojis = [\"🎉\", \"🎊\", \"🥳\", \"✨\", \"👍🏼\", \"🥰\", \"😍\", \"🍾\"];\n      const emoji = emojis[Math.floor(Math.random() * emojis.length)];\n      return (\n        <span role=\"img\" aria-label=\"muted\">\n          {emoji}\n        </span>\n      );\n    }\n\n    return (\n      <div className={highlit ? \"display highlit\" : \"display\"}>\n        {canReply && (\n          <p className=\"buttons\">\n            <button\n              type=\"button\"\n              className={\n                replyingComment\n                  ? \"btn btn-warning btn-sm\"\n                  : \"btn btn-info btn-sm\"\n              }\n              onClick={(event) => {\n                event.preventDefault();\n                setReplyComment(comment);\n              }}\n            >\n              {replyingComment ? \"Close\" : \"Reply\"}\n            </button>\n          </p>\n        )}\n        <h5>\n          By <b>{name ? name : <i>Anonymous</i>}</b>\n        </h5>\n        <p className=\"meta\">\n          <a\n            href={`#c${id}`}\n            title={created}\n            onClick={(event) => {\n              highlightComment(id);\n            }}\n          >\n            Posted <CustomTimeAgo date={created} title={created} />\n          </a>\n          {notApproved && <small>Not yet approved!</small>}\n        </p>\n        {comment.hasOwnProperty(\"was_searched_for\") && (\n          <p>\n            <i>Was it the song you were looking for?</i>{\" \"}\n            <b>{comment.was_searched_for ? \"Yes\" : \"No\"}</b>{\" \"}\n            {comment.was_searched_for && getRandomCelebration()}\n          </p>\n        )}\n\n        {typeof text === \"string\" ? (\n          <blockquote dangerouslySetInnerHTML={{ __html: text }} />\n        ) : (\n          <blockquote>{text}</blockquote>\n        )}\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}